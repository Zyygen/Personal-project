<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>Hồ sơ người dùng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <style>
    body{ background:#f8f9fa; }
    .panel{ border:1px solid #dee2e6; border-radius:.75rem; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    .panel-header{ background:var(--eaut-navy, #0b3761); color:#fff; padding:.65rem .9rem; font-weight:800; border-top-left-radius:.75rem; border-top-right-radius:.75rem; }
    .avatar{ width:84px; height:84px; border-radius:999px; display:grid; place-items:center; font-weight:800; color:#fff; background:var(--eaut-accent, #1e60a6); box-shadow:0 4px 16px rgba(0,0,0,.12);}
    .kv .k{color:#6c757d; font-size:.9rem;}
    .kv .v{font-weight:600;}
    .badge-chip{border-radius:999px; padding:.35rem .65rem; font-weight:600;}
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Navbar -->
  <div th:replace="fragments/header :: siteHeader"></div>

<main class="flex-grow-1">
  <div class="container my-4"
     th:with="
       isMember=${me != null and me.memberUntil != null and T(java.time.LocalDateTime).now().isBefore(me.memberUntil)},
       occName=${me != null and me.occupation != null ? me.occupation.name() : 'OTHER'},
       isStudent=${occName == 'STUDENT'},
       idLabel=${isStudent ? 'Mã SV' : 'CCCD'},
       idValue=${isStudent
                 ? (!#strings.isEmpty(me.studentCode) ? me.studentCode : '—')
                 : (!#strings.isEmpty(me.cccd)        ? me.cccd        : '—')}
     ">

    <div class="row justify-content-center">
      <div class="col-12 col-lg-10 col-xl-8">
        <div class="panel mb-4">
          <div class="panel-header">Hồ sơ</div>
          <div class="p-3">

            <!-- Header: avatar + tên + nhãn trạng thái -->
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="avatar"
                   th:text="${
                     (me != null and !#strings.isEmpty(me.fullName)) ? #strings.substring(me.fullName,0,1) :
                     ((me != null and !#strings.isEmpty(me.username)) ? #strings.substring(me.username,0,1) : 'U')
                   }">U</div>
              <div class="flex-grow-1">
                <div class="fw-bold fs-4"
                     th:text="${
                       (me != null and !#strings.isEmpty(me.fullName)) ? me.fullName :
                       (me != null ? me.username : '—')
                     }">User Name</div>
                <div class="text-muted" th:text="${me != null ? me.email : '—'}">email@example.com</div>
              </div>
              <div class="text-end">
                <!-- Trạng thái thành viên / thường -->
                <div>
                  <span class="badge badge-chip"
                        th:classappend="${isMember} ? ' bg-success' : ' bg-secondary'"
                        th:text="${isMember} ? 'Thành viên' : 'Tài khoản thường'">Tài khoản thường</span>
                </div>
                <!-- Trạng thái kích hoạt -->
                <div class="mt-2">
                  <span class="badge badge-chip"
                        th:classappend="${
                          me != null and me.status != null and me.status.name()=='ACTIVE' ? ' bg-primary' :
                          (me != null and me.status != null and me.status.name()=='SUSPENDED' ? ' bg-warning text-dark' : ' bg-secondary')
                        }"
                        th:text="${me != null and me.status != null ? me.status : 'UNKNOWN'}">ACTIVE</span>
                </div>
              </div>
            </div>

            <hr class="my-3"/>

            <!-- Thông tin tài khoản -->
            <div class="row kv gy-3">
              <div class="col-12 col-md-6">
                <div class="k">Tên đăng nhập</div>
                <div class="v" th:text="${me != null ? me.username : '—'}">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k">Email</div>
                <div class="v" th:text="${me != null ? me.email : '—'}">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k">Xác minh email</div>
                <div class="v">
                  <span class="badge badge-chip"
                        th:classappend="${me != null and me.emailVerified} ? ' bg-success' : ' bg-secondary'"
                        th:text="${me != null and me.emailVerified ? 'Đã xác minh' : 'Chưa xác minh'}">Đã xác minh</span>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k">Vai trò</div>
                <div class="v" th:text="${me != null and me.role != null ? me.role : '—'}">ROLE_USER</div>
              </div>
            </div>

            <hr class="my-3"/>

            <!-- Thông tin đăng ký (khớp entity User) -->
            <div class="row kv gy-3">
              <div class="col-12">
                <div class="fw-bold mb-1">Thông tin đăng ký</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="k">Họ và tên</div>
                <div class="v" th:text="${me != null and !#strings.isEmpty(me.fullName) ? me.fullName : '—'}">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k">Số điện thoại</div>
                <div class="v" th:text="${me != null and !#strings.isEmpty(me.phone) ? me.phone : '—'}">—</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="k" th:text="${idLabel}">Mã SV</div>
                <div class="v" th:text="${idValue}">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k">Nghề nghiệp</div>
                <div class="v"
			     th:text="${occName == 'STUDENT' ? 'Sinh viên' :
			              (occName == 'LECTURER' ? 'Giảng viên' : 'Khác')}">—</div>
			              </div>

              <div class="col-12 col-md-6">
                <div class="k">Ngày sinh</div>
                <div class="v" th:text="${me != null and me.dob != null ? #temporals.format(me.dob,'dd/MM/yyyy') : '—'}">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="k" th:text="${isMember} ? 'Hiệu lực thành viên đến' : 'Tài khoản thường'">Tài khoản Thường</div>
                <div class="v"
                     th:text="${isMember and me.memberUntil != null ? #temporals.format(me.memberUntil,'dd/MM/yyyy HH:mm') : '—'}">—</div>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <a class="btn btn-outline-primary" th:href="@{/change-password}">
                <i class="bi bi-key me-1"></i> Đổi mật khẩu
              </a>
              <a class="btn btn-outline-secondary"
                 th:href="@{/verify/resend}"
                 th:if="${me != null and !me.emailVerified}">
                <i class="bi bi-envelope-check me-1"></i> Gửi lại email xác minh
              </a>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</main>

  <div th:replace="fragments/footer :: siteFooter"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/footer.js}"></script>
</body>
</html>

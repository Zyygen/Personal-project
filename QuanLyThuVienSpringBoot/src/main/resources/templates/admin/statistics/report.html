<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Th·ªëng k√™ & B√°o c√°o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/header_ad.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/statistics.css}">
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Navbar -->
  <div th:replace="fragments/header_ad :: adminHeader"></div>

<main class="flex-grow-1 admin-stats">
<div class="container">

    <!-- ===== Th·ªëng k√™ m∆∞·ª£n ===== -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">üìä Th·ªëng k√™ m∆∞·ª£n s√°ch</div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                S√°ch m∆∞·ª£n h√¥m nay:
                <strong th:text="${todayBorrowCount}">0</strong>
            </li>
            <li class="list-group-item">
                S√°ch m∆∞·ª£n tu·∫ßn n√†y:
                <strong th:text="${weekBorrowCount}">0</strong>
            </li>
            <li class="list-group-item">
                S√°ch m∆∞·ª£n th√°ng n√†y:
                <strong th:text="${monthBorrowCount}">0</strong>
            </li>
        </ul>
    </div>

    <!-- ===== Danh s√°ch qu√° h·∫°n ===== -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">üìö Danh s√°ch tr·ªÖ h·∫°n</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered mb-0">
              <thead class="table-light">
				  <tr>
				    <th>T√™n s√°ch</th>
				    <th>S·ªë L∆∞·ª£ng</th>
				    <th>Ng∆∞·ªùi d√πng</th>
				    <th>Ng√†y m∆∞·ª£n</th>
				    <th>H·∫°n tr·∫£</th>
				    <th>S·ªë ng√†y tr·ªÖ</th>
				    <th>Ph·∫°t (VNƒê)</th>
				    <!-- C·ªòT M·ªöI -->
				    <th>C√≤n thi·∫øu (VNƒê)</th>
				    <th>T√¨nh tr·∫°ng</th>
				  </tr>
				</thead>
				<tbody>
				  <tr th:each="b : ${overdueList}"
				      th:with="
				        days=${b.calcOverdueDays24h()},
				        fine=${b.calcFineAmount(5000)},
				        paid=${b.finePaidTotal != null ? b.finePaidTotal : T(java.math.BigDecimal).ZERO},
				        remaining=${fine.subtract(paid).compareTo(T(java.math.BigDecimal).ZERO) > 0 ? fine.subtract(paid) : T(java.math.BigDecimal).ZERO}
				      ">
				    <td th:text="${b.book.title}">Ti√™u ƒë·ªÅ</td>
				    <td th:text="${entry.amount != null ? entry.amount : 1}">1</td>
				    <td th:text="${b.user.username}">user</td>
				    <td th:text="${#temporals.format(b.borrowDate, 'dd/MM/yyyy HH:mm')}">‚Äî</td>
				    <td th:text="${#temporals.format(b.dueDate, 'dd/MM/yyyy HH:mm')}">‚Äî</td>
				
				    <!-- S·ªë ng√†y tr·ªÖ: ƒë·ªß 24h m·ªõi t√≠nh 1 ng√†y -->
				    <td th:text="${days}">0</td>
				
				    <!-- Ph·∫°t (VNƒê) = days √ó amount √ó 5000 -->
				    <td th:text="${#numbers.formatDecimal(fine,0,'COMMA',0,'POINT')}">0</td>
				
				    <!-- C·ªôt m·ªõi: C√≤n thi·∫øu (VNƒê) = max(fine - paid, 0) -->
				    <td th:text="${#numbers.formatDecimal(remaining,0,'COMMA',0,'POINT')}">0</td>
				
				    <td>
				      <span th:class="${b.returnDate == null} ? 'badge bg-warning text-dark' : 'badge bg-success'"
				            th:text="${b.returnDate == null ? 'Ch∆∞a tr·∫£' : 'ƒê√£ tr·∫£'}">Ch∆∞a tr·∫£</span>
				    </td>
				  </tr>
				
				  <tr th:if="${#lists.isEmpty(overdueList)}">
				    <td colspan="8" class="text-center text-muted fw-bold">
				      Hi·ªán t·∫°i kh√¥ng c√≥ sinh vi√™n tr·ªÖ h·∫°n.
				    </td>
				  </tr>
				</tbody>
            </table>
          </div>
        </div>
    </div>

    <!-- ===== Sinh vi√™n m∆∞·ª£n nhi·ªÅu ===== -->
    <div class="card">
      <div class="card-header bg-success text-white">üèÖ Sinh vi√™n m∆∞·ª£n nhi·ªÅu s√°ch nh·∫•t</div>
      <div class="card-body">
        <p class="fs-5" th:if="${topBorrower != null}">
		  <strong th:text="${topBorrower.username}">user@example.com</strong>
		  - T·ªïng s·ªë s√°ch ƒë√£ m∆∞·ª£n:
		  <strong th:text="${topBorrower.total}">0</strong>
		</p>
		<p class="text-muted" th:if="${topBorrower == null}">
		  Kh√¥ng c√≥ d·ªØ li·ªáu sinh vi√™n m∆∞·ª£n nhi·ªÅu nh·∫•t.
		</p>
      </div>
    </div>

    <!-- ===== Danh s√°ch sinh vi√™n ƒëang m∆∞·ª£n ===== -->
    <div class="card mt-4">
      <div class="card-header bg-info text-white">üìã Danh s√°ch sinh vi√™n ƒëang m∆∞·ª£n s√°ch</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered mb-0">
            <thead class="table-light">
              <tr>
                <th>Ng∆∞·ªùi d√πng</th>
                <th>T√™n s√°ch</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Ng√†y m∆∞·ª£n</th>
                <th>H·∫°n tr·∫£</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="entry : ${borrowersPage != null ? borrowersPage.content : {}}">
                <td th:text="${entry.user != null ? entry.user.username : '‚Äî'}">‚Äî</td>
                <td th:text="${entry.book != null ? entry.book.title    : '‚Äî'}">‚Äî</td>
                <td th:text="${entry.amount != null ? entry.amount : 1}">1</td>
                <td th:text="${entry.borrowDate != null ? #temporals.format(entry.borrowDate,'dd/MM/yyyy HH:mm') : '‚Äî'}">‚Äî</td>
                <td th:text="${entry.dueDate    != null ? #temporals.format(entry.dueDate,'dd/MM/yyyy HH:mm')     : '‚Äî'}">‚Äî</td>
              </tr>

              <tr th:if="${borrowersPage == null or borrowersPage.totalElements == 0}">
                <td colspan="5" class="text-center text-muted fw-bold">
                  Hi·ªán t·∫°i kh√¥ng c√≥ sinh vi√™n n√†o ƒëang m∆∞·ª£n s√°ch.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Ph√¢n trang -->
      <div class="card-footer" th:if="${borrowersPage != null and borrowersPage.totalElements > borrowersPage.size}">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" th:classappend="${borrowersPage.first} ? ' disabled'">
              <a class="page-link" th:href="@{/admin/statistics/report(page=${borrowersPage.number - 1})}">Tr∆∞·ªõc</a>
            </li>
            <li class="page-item"
                th:each="pageNum : ${#numbers.sequence(0, borrowersPage.totalPages - 1)}"
                th:classappend="${pageNum == borrowersPage.number} ? ' active'">
              <a class="page-link" th:href="@{/admin/statistics/report(page=${pageNum})}" th:text="${pageNum + 1}">1</a>
            </li>
            <li class="page-item" th:classappend="${borrowersPage.last} ? ' disabled'">
              <a class="page-link" th:href="@{/admin/statistics/report(page=${borrowersPage.number + 1})}">Ti·∫øp</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

</div>
</main>

  <div th:replace="fragments/footer :: siteFooter"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/footer.js}"></script>
</body>
</html>
